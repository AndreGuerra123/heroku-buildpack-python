#!/usr/bin/env bash

# Detect Python-version with Pipenv.
set +e
if [[ -f $BUILD_DIR/Pipfile || -f $BUILD_DIR/Pipfile.lock && ! -f $BUILD_DIR/runtime.txt]]; then
    if [[ ! -f $BUILD_DIR/Pipfile.lock ]]; then
        puts-warn "No 'Pipfile.lock' found! We recommend you commit this into your repository."
        PYTHON_FULL=$(sed -nr "/^\[requires\]/ { :l /^python_full_version[ ]*=/ { s/.*=[ ]*//; p; q;}; n; b l;}" "$BUILD_DIR/Pipfile" | tr -d '"')
        PYTHON=$(sed -nr "/^\[requires\]/ { :l /^python_version[ ]*=/ { s/.*=[ ]*//; p; q;}; n; b l;}" "$BUILD_DIR/Pipfile" | tr -d '"')
    else
        PYTHON_FULL=$(jq -r '._meta.requires.python_full_version' "$BUILD_DIR/Pipfile.lock")
        PYTHON=$(jq -r '._meta.requires.python_version' "$BUILD_DIR/Pipfile.lock")
    fi
    if ! [ -z "$PYTHON_FULL"]; then
        echo "python-$PYTHON_FULL" > "$BUILD_DIR/runtime.txt"
    elif ! [ -z "$PYTHON"]; then
        if [ "$PYTHON" = 2.7 ]; then
            echo "$LATEST_27" > "$BUILD_DIR/runtime.txt"
        elif [ "$PYTHON" = 3.4 ]; then
            echo "$LATEST_34" > "$BUILD_DIR/runtime.txt"
        elif [ "$PYTHON" = 3.5 ]; then
            echo "$LATEST_35" > "$BUILD_DIR/runtime.txt"
        elif [ "$PYTHON" = 3.6 ]; then
            echo "$LATEST_36" > "$BUILD_DIR/runtime.txt"
        elif [ "$PYTHON" = 3.7 ]; then
            echo "$LATEST_37" > "$BUILD_DIR/runtime.txt"
        fi
    fi
fi
set -e